<html>
<head>
<title>client.c</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
client.c</font>
</center></td></tr></table>
<pre><span class="s0">/** 
 *  Autor: Andrés Bernárdez Matalobos 
 *  Asignatura: XARXES. 
 *  Práctica 1  
 *  
 *  
 **/</span>

<span class="s2">#include </span><span class="s3">&lt;stdio.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;string.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;sys/types.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;sys/socket.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;sys/time.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;net/if.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;sys/ioctl.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;netinet/in.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;stdlib.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;unistd.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;time.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;pthread.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;unistd.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;sys/select.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;poll.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;arpa/inet.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;stdbool.h&gt;</span>

<span class="s0">//client information</span>
<span class="s4">char </span><span class="s1">id_equip[</span><span class="s5">6</span><span class="s1">]</span><span class="s4">;</span>
<span class="s4">char </span><span class="s1">adress_MAC[</span><span class="s5">12</span><span class="s1">]</span><span class="s4">;</span>
<span class="s4">char </span><span class="s1">NMS_id[</span><span class="s5">16</span><span class="s1">]</span><span class="s4">;</span>
<span class="s4">char </span><span class="s1">NMS_UDP_port[</span><span class="s5">6</span><span class="s1">]</span><span class="s4">;</span>
<span class="s4">char </span><span class="s1">random_number[</span><span class="s5">7</span><span class="s1">] = {</span><span class="s3">'0'</span><span class="s4">,</span><span class="s3">'0'</span><span class="s4">,</span><span class="s3">'0'</span><span class="s4">,</span><span class="s3">'0'</span><span class="s4">,</span><span class="s3">'0'</span><span class="s4">,</span><span class="s3">'0'</span><span class="s4">,</span><span class="s3">'</span><span class="s4">\0</span><span class="s3">'</span><span class="s1">}</span><span class="s4">;</span>
<span class="s4">int </span><span class="s1">actual_state</span><span class="s4">; </span><span class="s0">// estado actual del cliente es un int</span>

<span class="s0">//sever information</span>
<span class="s4">char </span><span class="s1">id_server[</span><span class="s5">6</span><span class="s1">]</span><span class="s4">;</span>
<span class="s4">char </span><span class="s1">adress_MAC_server[</span><span class="s5">12</span><span class="s1">]</span><span class="s4">;</span>
<span class="s4">unsigned long </span><span class="s1">ip_server</span><span class="s4">;</span>

<span class="s0">//tipos de PDU en el registro</span>
<span class="s2">#define </span><span class="s1">NO_RESPONSE </span><span class="s5">0X08</span>
<span class="s2">#define </span><span class="s1">REGISTER_REQ </span><span class="s5">0X00</span>
<span class="s2">#define </span><span class="s1">REGISTER_ACK </span><span class="s5">0X02</span>
<span class="s2">#define </span><span class="s1">REGISTER_NACK </span><span class="s5">0X04</span>
<span class="s2">#define </span><span class="s1">REGISTER_REJ </span><span class="s5">0X06</span>
<span class="s2">#define </span><span class="s1">ERROR </span><span class="s5">0X0F</span>


<span class="s0">//estados del registro</span>
<span class="s2">#define </span><span class="s1">DISCONNECTED </span><span class="s5">0XA0</span>
<span class="s2">#define </span><span class="s1">WAIT_REG_RESPONSE </span><span class="s5">0XA2</span>
<span class="s2">#define </span><span class="s1">WAIT_DB_CHECK </span><span class="s5">0XA4</span>
<span class="s2">#define </span><span class="s1">REGISTERED </span><span class="s5">0XA6</span>
<span class="s2">#define </span><span class="s1">SEND_ALIVE </span><span class="s5">0XA8</span>

<span class="s0">//tamaño de los paquetes</span>
<span class="s2">#define </span><span class="s1">MAX_PACKAGE_LENGTH </span><span class="s5">100</span>
<span class="s2">#define </span><span class="s1">MAX_FILE_PATH_LENGTH </span><span class="s5">100</span>
<span class="s2">#define </span><span class="s1">MAX_COMMANDS_LENGTH </span><span class="s5">100</span>

<span class="s0">//paquete</span>
<span class="s0">//package_to_send[78];</span>
<span class="s4">char</span><span class="s1">* package_to_check</span><span class="s4">;</span>

<span class="s0">//variables de control de programa (read configuration)</span>
<span class="s1">bool debug = false</span><span class="s4">;</span>
<span class="s4">char </span><span class="s1">config_file[MAX_FILE_PATH_LENGTH]</span><span class="s4">;</span>
<span class="s4">char </span><span class="s1">network_file[MAX_FILE_PATH_LENGTH]</span><span class="s4">;</span>
<span class="s0">//variables para openupdsocketc</span>
<span class="s4">char</span><span class="s1">* ip_client = </span><span class="s3">&quot;127.0.0.1&quot;</span><span class="s4">;</span>
<span class="s4">char</span><span class="s1">* package</span><span class="s4">;</span>

<span class="s0">//variables locales sockect</span>
<span class="s4">struct </span><span class="s1">sockaddr_in	addr_server</span><span class="s4">,</span><span class="s1">addr_client</span><span class="s4">;</span>
<span class="s4">int </span><span class="s1">sock_udp</span><span class="s4">,</span><span class="s1">sock_tcp</span><span class="s4">;</span>
<span class="s1">socklen_t laddr_server</span><span class="s4">;</span>

<span class="s4">struct </span><span class="s1">pdu_upd{</span>
    <span class="s4">unsigned char </span><span class="s1">type</span><span class="s4">;</span>
    <span class="s4">char </span><span class="s1">id_equip_pdu[</span><span class="s5">7</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s4">char </span><span class="s1">address_MAC_pdu[</span><span class="s5">13</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s4">char </span><span class="s1">num_aleatorio_pdu[</span><span class="s5">7</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s4">char </span><span class="s1">data_pdu[</span><span class="s5">50</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span><span class="s4">;</span>
<span class="s0">//variables client_registered</span>
<span class="s2">#define </span><span class="s1">T </span><span class="s5">1</span>
<span class="s2">#define </span><span class="s1">P </span><span class="s5">2</span>
<span class="s2">#define </span><span class="s1">Q </span><span class="s5">3</span>
<span class="s2">#define </span><span class="s1">U </span><span class="s5">2</span>
<span class="s2">#define </span><span class="s1">N </span><span class="s5">6</span>
<span class="s2">#define </span><span class="s1">O </span><span class="s5">2</span>
<span class="s4">int </span><span class="s1">tries_counter_registered = </span><span class="s5">0</span><span class="s4">;</span>
<span class="s4">int </span><span class="s1">package_counter_registered= </span><span class="s5">0</span><span class="s4">;</span>
<span class="s4">int </span><span class="s1">package_counter_alive= </span><span class="s5">0</span><span class="s4">;</span>


<span class="s4">void </span><span class="s1">client_registered()</span><span class="s4">;</span>
<span class="s4">int </span><span class="s1">timing_registered()</span><span class="s4">;</span>

<span class="s0">//lee el fichero de configuracion y guarda los datos en las variables globales</span>
<span class="s4">void </span><span class="s1">read_configuration (</span><span class="s4">char </span><span class="s1">*config_file) {</span>
    <span class="s1">FILE *file</span><span class="s4">; </span><span class="s0">//puntero al fichero</span>
    <span class="s4">char </span><span class="s1">line[MAX_FILE_PATH_LENGTH]</span><span class="s4">; </span><span class="s0">//linea del fichero</span>
    <span class="s4">char </span><span class="s1">*token</span><span class="s4">; </span><span class="s0">//token de la linea</span>
    <span class="s4">int </span><span class="s1">i = </span><span class="s5">0</span><span class="s4">; </span><span class="s0">//contador de tokens</span>
    <span class="s1">bool flag = false</span><span class="s4">; </span><span class="s0">//flag para saber si el token es el que queremos</span>


    <span class="s1">file = fopen(config_file</span><span class="s4">, </span><span class="s3">&quot;r&quot;</span><span class="s1">)</span><span class="s4">; </span><span class="s0">//abrimos el fichero en modo lectura</span>

    <span class="s4">if </span><span class="s1">(file == NULL) { </span><span class="s0">//comprobamos que se ha abierto correctamente</span>
        <span class="s1">printf(</span><span class="s3">&quot;Error opening the configuration file.</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">; </span><span class="s0">//si no se ha abierto correctamente, salimos del programa</span>
        <span class="s1">exit(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s4">while </span><span class="s1">(fgets(line</span><span class="s4">, </span><span class="s1">MAX_FILE_PATH_LENGTH</span><span class="s4">, </span><span class="s1">file) != NULL) { </span><span class="s0">//mientras haya elementos leemos el fichero linea a linea</span>
        <span class="s1">token = strtok(line</span><span class="s4">, </span><span class="s3">&quot; &quot;</span><span class="s1">)</span><span class="s4">; </span><span class="s0">//separamos la linea en tokens</span>

        <span class="s4">while </span><span class="s1">(token != NULL) { </span><span class="s0">//mientras haya tokens</span>

            <span class="s4">if </span><span class="s1">(flag) { </span><span class="s0">//si el token es el que queremos</span>
                <span class="s4">if </span><span class="s1">(i == </span><span class="s5">0</span><span class="s1">) { </span><span class="s0">//si es el primer token, lo guardamos en la variable id_equip</span>
                    <span class="s1">strcpy((</span><span class="s4">char </span><span class="s1">*) id_equip</span><span class="s4">, </span><span class="s1">token)</span><span class="s4">;</span><span class="s1">}</span>
                <span class="s4">if </span><span class="s1">(i == </span><span class="s5">1</span><span class="s1">) {</span>
                    <span class="s1">strcpy((</span><span class="s4">char </span><span class="s1">*) adress_MAC</span><span class="s4">, </span><span class="s1">token)</span><span class="s4">;</span><span class="s1">}</span>
                <span class="s4">if </span><span class="s1">(i == </span><span class="s5">2</span><span class="s1">) {</span>
                    <span class="s1">strcpy((</span><span class="s4">char </span><span class="s1">*) NMS_id</span><span class="s4">, </span><span class="s1">token)</span><span class="s4">;</span><span class="s1">}</span>
                <span class="s4">if </span><span class="s1">(i == </span><span class="s5">3</span><span class="s1">) {</span>
                    <span class="s1">strcpy((</span><span class="s4">char </span><span class="s1">*) NMS_UDP_port</span><span class="s4">, </span><span class="s1">token)</span><span class="s4">;</span>
                <span class="s1">}</span>
                <span class="s1">i++</span><span class="s4">; </span><span class="s0">//incrementamos el contador de tokens</span>
            <span class="s1">}</span>
            <span class="s1">token = strtok(NULL</span><span class="s4">, </span><span class="s3">&quot; &quot;</span><span class="s1">)</span><span class="s4">; </span><span class="s0">//leemos el siguiente token</span>
            <span class="s1">flag = !flag</span><span class="s4">; </span><span class="s0">//cambiamos el valor del flag</span>

        <span class="s1">}</span>

    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">//lee los parametros de entrada y los guarda en las variables globales</span>
<span class="s4">void </span><span class="s1">read_parameters (</span><span class="s4">int </span><span class="s1">argc</span><span class="s4">, char </span><span class="s1">*argv[]) {</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">1</span><span class="s4">; </span><span class="s1">i &lt; argc</span><span class="s4">; </span><span class="s1">i++) {</span>
        <span class="s4">if </span><span class="s1">(strcmp(argv[i]</span><span class="s4">, </span><span class="s3">&quot;-c&quot;</span><span class="s1">) == </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(i + </span><span class="s5">1 </span><span class="s1">&lt; argc) {</span>
                <span class="s1">i++</span><span class="s4">;</span>
                <span class="s1">strcpy(config_file</span><span class="s4">, </span><span class="s1">argv[i])</span><span class="s4">;</span>
            <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
                <span class="s1">printf(</span><span class="s3">&quot;Error: No configuration file specified.</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
                <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s4">else if </span><span class="s1">(strcmp(argv[i]</span><span class="s4">, </span><span class="s3">&quot;-d&quot;</span><span class="s1">) == </span><span class="s5">0</span><span class="s1">){</span>
            <span class="s1">debug = true</span><span class="s4">;</span>
            <span class="s1">printf(</span><span class="s3">&quot;Debug mode activated.</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">} </span><span class="s4">else if </span><span class="s1">(strcmp(argv[i]</span><span class="s4">, </span><span class="s3">&quot;-f&quot;</span><span class="s1">) == </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(i + </span><span class="s5">1 </span><span class="s1">&lt; argc) {</span>
                <span class="s1">i++</span><span class="s4">;</span>
                <span class="s1">strcpy(network_file</span><span class="s4">, </span><span class="s1">argv[i])</span><span class="s4">;</span>
            <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
                <span class="s1">printf(</span><span class="s3">&quot;Error: No configuration file specified.</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
                <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s1">printf(</span><span class="s3">&quot;Error: Invalid parameter.</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
            <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s4">char</span><span class="s1">* create_package (</span><span class="s4">int </span><span class="s1">type</span><span class="s4">, char</span><span class="s1">* data){</span>
    <span class="s4">char</span><span class="s1">* result</span><span class="s4">;</span>
    <span class="s1">result = (</span><span class="s4">char</span><span class="s1">*) malloc(</span><span class="s5">78</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">result[</span><span class="s5">0</span><span class="s1">] = type</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">1</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">8</span><span class="s4">; </span><span class="s1">i++){</span>
        <span class="s4">if</span><span class="s1">(i&lt;</span><span class="s5">7</span><span class="s1">) {</span>
            <span class="s1">result[i] = id_equip[i - </span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
        <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
            <span class="s1">result[i] = </span><span class="s3">'</span><span class="s4">\0</span><span class="s3">'</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">8</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">21</span><span class="s4">; </span><span class="s1">i++){</span>
        <span class="s4">if</span><span class="s1">(i&lt;</span><span class="s5">20</span><span class="s1">){</span>
            <span class="s1">result[i] = adress_MAC[i-</span><span class="s5">8</span><span class="s1">]</span><span class="s4">;</span>
        <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
            <span class="s1">result[i] = </span><span class="s3">'</span><span class="s4">\0</span><span class="s3">'</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">21</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">28</span><span class="s4">; </span><span class="s1">i++){</span>
        <span class="s4">if</span><span class="s1">(i&lt;</span><span class="s5">27</span><span class="s1">){</span>
            <span class="s1">result[i] = random_number[i-</span><span class="s5">21</span><span class="s1">]</span><span class="s4">;</span>
        <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
            <span class="s1">result[i] = </span><span class="s3">'</span><span class="s4">\0</span><span class="s3">'</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">28</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">78</span><span class="s4">; </span><span class="s1">i++){</span>
        <span class="s1">result[i] = data[i-</span><span class="s5">28</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s4">return </span><span class="s1">result</span><span class="s4">;</span>
<span class="s1">}</span>
<span class="s4">void </span><span class="s1">print_package (</span><span class="s4">char</span><span class="s1">* package_to_check){</span>

    <span class="s1">printf(</span><span class="s3">&quot;Tipo de paquete: %x</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s4">, </span><span class="s1">package_to_check[</span><span class="s5">0</span><span class="s1">])</span><span class="s4">;</span>


    <span class="s1">printf(</span><span class="s3">&quot;ID del equipo: &quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">1</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">7</span><span class="s4">; </span><span class="s1">i++){</span>
        <span class="s1">printf(</span><span class="s3">&quot;%c&quot;</span><span class="s4">, </span><span class="s1">package_to_check[i])</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s1">printf(</span><span class="s3">&quot;</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">printf(</span><span class="s3">&quot;Adress Mac: &quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">7</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">20</span><span class="s4">; </span><span class="s1">i++){</span>
        <span class="s1">printf(</span><span class="s3">&quot;%c&quot;</span><span class="s4">, </span><span class="s1">package_to_check[i])</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">printf(</span><span class="s3">&quot;Random number: &quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">20</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">27</span><span class="s4">; </span><span class="s1">i++){</span>
        <span class="s1">printf(</span><span class="s3">&quot;%c&quot;</span><span class="s4">, </span><span class="s1">package_to_check[i])</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s1">printf(</span><span class="s3">&quot;</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">printf(</span><span class="s3">&quot;Datos: &quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">28</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">78 </span><span class="s1">&amp;&amp; package_to_check[i] != </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i++){</span>
        <span class="s1">printf(</span><span class="s3">&quot;%c&quot;</span><span class="s4">, </span><span class="s1">package_to_check[i])</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s1">printf(</span><span class="s3">&quot;</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

<span class="s1">}</span>

<span class="s4">void </span><span class="s1">open_udp_socket(){</span>
    <span class="s1">sock_udp = socket(AF_INET</span><span class="s4">, </span><span class="s1">SOCK_DGRAM</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">if</span><span class="s1">(sock_udp &lt; </span><span class="s5">0</span><span class="s1">) </span><span class="s0">//si despues de crearlo te ha devuelto menor que cero es porque no lo ha podido crear</span>
    <span class="s1">{</span>
        <span class="s1">printf(</span><span class="s3">&quot;Can´t open socket!!!</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">exit(-</span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">memset(&amp;addr_client</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, sizeof </span><span class="s1">(</span><span class="s4">struct </span><span class="s1">sockaddr_in))</span><span class="s4">; </span><span class="s0">// guarda memoria para structs</span>
    <span class="s1">addr_client.sin_family = AF_INET</span><span class="s4">;</span>
    <span class="s1">addr_client.sin_addr.s_addr = inet_addr(ip_client)</span><span class="s4">;</span>
    <span class="s1">addr_client.sin_port = htons(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s0">/* binding (ligar) */</span>
    <span class="s4">if</span><span class="s1">(bind(sock_udp</span><span class="s4">, </span><span class="s1">(</span><span class="s4">struct </span><span class="s1">sockaddr *)&amp;addr_client</span><span class="s4">, sizeof</span><span class="s1">(</span><span class="s4">struct </span><span class="s1">sockaddr_in)) &lt; </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s1">fprintf(stderr</span><span class="s4">, </span><span class="s3">&quot; Can´t do socket's binding !!!</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">exit(-</span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">memset(&amp;addr_server</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, sizeof</span><span class="s1">(addr_server))</span><span class="s4">;</span>

    <span class="s1">addr_server.sin_family = AF_INET</span><span class="s4">;</span>
    <span class="s1">addr_server.sin_port = htons(atoi(NMS_UDP_port))</span><span class="s4">;</span>
    <span class="s1">addr_server.sin_addr.s_addr = atoi(NMS_id)</span><span class="s4">;</span>
    <span class="s1">printf(</span><span class="s3">&quot;succesfull socket!!!</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

<span class="s1">}</span>
<span class="s4">void </span><span class="s1">send_udp_package(</span><span class="s4">char</span><span class="s1">* package_to_send){</span>
    <span class="s4">if </span><span class="s1">(sendto(sock_udp</span><span class="s4">, </span><span class="s1">package_to_send</span><span class="s4">, </span><span class="s5">78</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">(</span><span class="s4">struct </span><span class="s1">sockaddr *) &amp;addr_server</span><span class="s4">, sizeof</span><span class="s1">( addr_server)) &lt; </span><span class="s5">0</span><span class="s1">){</span>
        <span class="s1">printf(</span><span class="s3">&quot;Error sending package</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s4">else</span><span class="s1">{</span>
        <span class="s1">printf(</span><span class="s3">&quot;Package sent</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">}</span>

<span class="s1">}</span>

<span class="s4">void </span><span class="s1">print_debug(</span><span class="s4">char</span><span class="s1">* message){ </span><span class="s0">//funcion para imprimir mensajes de debug</span>
    <span class="s4">if </span><span class="s1">(debug){</span>
        <span class="s0">//print_time();</span>
        <span class="s1">printf(</span><span class="s3">&quot;%s</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s4">, </span><span class="s1">message)</span><span class="s4">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">receive_udp_package(</span><span class="s4">float </span><span class="s1">waiting_time) {</span>
    <span class="s4">struct </span><span class="s1">timeval tv</span><span class="s4">;</span>
    <span class="s1">package = malloc(</span><span class="s5">78</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">tv.tv_sec = waiting_time</span><span class="s4">;</span>
    <span class="s1">tv.tv_usec = </span><span class="s5">0</span><span class="s4">;</span>
    <span class="s1">setsockopt(sock_udp</span><span class="s4">, </span><span class="s1">SOL_SOCKET</span><span class="s4">, </span><span class="s1">SO_RCVTIMEO</span><span class="s4">, </span><span class="s1">&amp;tv</span><span class="s4">, sizeof </span><span class="s1">tv)</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(recvfrom(sock_udp</span><span class="s4">, </span><span class="s1">package</span><span class="s4">, </span><span class="s5">78</span><span class="s4">, </span><span class="s5">0</span><span class="s4">,</span><span class="s1">(</span><span class="s4">struct </span><span class="s1">sockaddr *) &amp;addr_server</span><span class="s4">, </span><span class="s1">&amp;laddr_server) &lt; </span><span class="s5">0</span><span class="s1">) {</span>
        <span class="s1">printf(</span><span class="s3">&quot;No se han recibido paquetes en el tiempo</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">package[</span><span class="s5">0</span><span class="s1">]=NO_RESPONSE</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
        <span class="s4">if </span><span class="s1">(package[</span><span class="s5">0</span><span class="s1">] == REGISTER_ACK) {</span>
            <span class="s1">printf(</span><span class="s3">&quot;Se ha recibido un ACK</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">} </span><span class="s4">else if </span><span class="s1">(package[</span><span class="s5">0</span><span class="s1">] == REGISTER_NACK) {</span>
            <span class="s1">printf(</span><span class="s3">&quot;Se ha recibido un NACK</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">} </span><span class="s4">else if </span><span class="s1">(package[</span><span class="s5">0</span><span class="s1">] == REGISTER_REJ) {</span>
            <span class="s1">printf(</span><span class="s3">&quot;Se ha recibido un REJ</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">} </span><span class="s4">else if </span><span class="s1">(package[</span><span class="s5">0</span><span class="s1">] == REGISTER_REQ) {</span>
            <span class="s1">printf(</span><span class="s3">&quot;Se ha recibido un REQ</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s1">printf(</span><span class="s3">&quot;Se ha recibido un paquete no reconocido</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">check_package(</span><span class="s4">char</span><span class="s1">* package_to_check){</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">1</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">7</span><span class="s4">; </span><span class="s1">i++) {</span>
        <span class="s4">if </span><span class="s1">(package_to_check[i] != id_equip[i - </span><span class="s5">1</span><span class="s1">]) {</span>
            <span class="s1">printf(</span><span class="s3">&quot;Not the expected id</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
            <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">7</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">20</span><span class="s4">; </span><span class="s1">i++) {</span>
        <span class="s4">if </span><span class="s1">(package_to_check[i] != adress_MAC[i - </span><span class="s5">7</span><span class="s1">]) {</span>
            <span class="s1">printf(</span><span class="s3">&quot;Not the expected MAC</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
            <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">20</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">27</span><span class="s4">; </span><span class="s1">i++){</span>
        <span class="s4">if</span><span class="s1">(package_to_check[i] != random_number[i-</span><span class="s5">20</span><span class="s1">]){</span>
            <span class="s1">printf(</span><span class="s3">&quot;Not the expected number</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
            <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">if</span><span class="s1">(addr_server.sin_addr.s_addr != ip_server){</span>
        <span class="s1">printf(</span><span class="s3">&quot;Not the expected ip</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s4">void </span><span class="s1">package_management_register(){</span>
    <span class="s1">receive_udp_package(timing_registered())</span><span class="s4">;</span>
    <span class="s4">if</span><span class="s1">(package[</span><span class="s5">0</span><span class="s1">] == NO_RESPONSE){</span>

        <span class="s4">if</span><span class="s1">(package_counter_registered &gt; N){</span>
            <span class="s4">if</span><span class="s1">(tries_counter_registered &gt; O){</span>
                <span class="s1">printf(</span><span class="s3">&quot;Se han superado el numero de intentos permitidos: %i, se finaliza el programa</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s4">, </span><span class="s1">O)</span><span class="s4">;</span>
                <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
            <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
                <span class="s1">tries_counter_registered++</span><span class="s4">;</span>
                <span class="s1">package_counter_registered = </span><span class="s5">0</span><span class="s4">;</span>
                <span class="s1">client_registered()</span><span class="s4">;</span>
            <span class="s1">}</span>

        <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s1">package_counter_registered++</span><span class="s4">;</span>
            <span class="s1">client_registered()</span><span class="s4">;</span>
        <span class="s1">}</span>

    <span class="s1">}</span>
    <span class="s4">else if </span><span class="s1">(package[</span><span class="s5">0</span><span class="s1">] == REGISTER_ACK) {</span>
        <span class="s1">actual_state = REGISTERED</span><span class="s4">;</span>
        <span class="s1">printf(</span><span class="s3">&quot;Actual state: REGISTERED</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

        <span class="s0">//guardar el id_server, adress_MAC_server, ip_server</span>
        <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">1</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">7</span><span class="s4">; </span><span class="s1">i++) {</span>
            <span class="s1">id_server[i - </span><span class="s5">1</span><span class="s1">] = package[i]</span><span class="s4">;</span>
        <span class="s1">}</span>
        <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">7</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">13</span><span class="s4">; </span><span class="s1">i++) {</span>
            <span class="s1">adress_MAC_server[i - </span><span class="s5">7</span><span class="s1">] = package[i]</span><span class="s4">;</span>
        <span class="s1">}</span>
        <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">13</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">20</span><span class="s4">; </span><span class="s1">i++) {</span>
            <span class="s1">random_number[i - </span><span class="s5">13</span><span class="s1">] = package[i]</span><span class="s4">;</span>
        <span class="s1">}</span>
        <span class="s1">ip_server = addr_server.sin_addr.s_addr</span><span class="s4">;</span>


    <span class="s1">}</span>


    <span class="s4">else if </span><span class="s1">(package[</span><span class="s5">0</span><span class="s1">] == REGISTER_NACK){</span>
        <span class="s1">printf(</span><span class="s3">&quot;Se ha recibido un paquete NACK</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">28</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">78 </span><span class="s1">&amp;&amp; package_to_check[i] != </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i++){</span>
            <span class="s1">printf(</span><span class="s3">&quot;%c&quot;</span><span class="s4">, </span><span class="s1">package_to_check[i])</span><span class="s4">;</span>
        <span class="s1">}</span>
        <span class="s1">printf(</span><span class="s3">&quot;</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">tries_counter_registered++</span><span class="s4">;</span>
        <span class="s1">package_counter_registered = </span><span class="s5">0</span><span class="s4">;</span>
        <span class="s1">client_registered()</span><span class="s4">;</span>

    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(package[</span><span class="s5">0</span><span class="s1">] == REGISTER_REJ){</span>
        <span class="s1">actual_state = DISCONNECTED</span><span class="s4">;</span>
        <span class="s1">printf(</span><span class="s3">&quot;Actual state: %i</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s4">, </span><span class="s1">actual_state)</span><span class="s4">;</span>


        <span class="s1">printf(</span><span class="s3">&quot;Se ha recibido un paquete REJ, se finaliza el programa</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">28</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">78 </span><span class="s1">&amp;&amp; package_to_check[i] != </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i++){</span>
            <span class="s1">printf(</span><span class="s3">&quot;%c&quot;</span><span class="s4">, </span><span class="s1">package_to_check[i])</span><span class="s4">;</span>
        <span class="s1">}</span>
        <span class="s1">printf(</span><span class="s3">&quot;</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else</span><span class="s1">{</span>
        <span class="s1">printf(</span><span class="s3">&quot;Se ha recibido un paquete no reconocido, se finaliza el programa</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">exit(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">}</span>

<span class="s1">}</span>


<span class="s4">int </span><span class="s1">timing_registered() {</span>
    <span class="s4">if </span><span class="s1">(package_counter_registered &lt; P) {</span>
        <span class="s4">return </span><span class="s1">T</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(package_counter_registered &lt; Q) {</span>
        <span class="s4">return </span><span class="s1">T *((package_counter_registered - P) + </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
        <span class="s4">return </span><span class="s1">T * Q</span><span class="s4">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">client_registered(){</span>
    <span class="s1">send_udp_package(create_package(REGISTER_REQ</span><span class="s4">, </span><span class="s3">&quot;Hola&quot;</span><span class="s1">))</span><span class="s4">;</span>
    <span class="s1">actual_state = WAIT_REG_RESPONSE</span><span class="s4">;</span>
    <span class="s1">package_management_register()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">change_state(</span><span class="s4">int </span><span class="s1">state) {</span>
    <span class="s4">if </span><span class="s1">(actual_state != state) {</span>
        <span class="s1">actual_state = state</span><span class="s4">;</span>
        <span class="s1">printf(</span><span class="s3">&quot;Actual state: %i</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s4">, </span><span class="s1">actual_state)</span><span class="s4">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">int </span><span class="s1">main(</span><span class="s4">int </span><span class="s1">argc</span><span class="s4">, char </span><span class="s1">*argv[]) {</span>
    <span class="s1">strcpy(config_file</span><span class="s4">, </span><span class="s3">&quot;client.cfg&quot;</span><span class="s1">)</span><span class="s4">; </span><span class="s0">//default configuration file</span>
    <span class="s1">read_parameters(argc</span><span class="s4">, </span><span class="s1">argv)</span><span class="s4">;</span>
    <span class="s1">read_configuration(config_file)</span><span class="s4">; </span><span class="s0">//read the configuration file</span>

    <span class="s1">create_package(REGISTER_REQ</span><span class="s4">, </span><span class="s3">&quot;Hola&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">print_package(create_package(REGISTER_REQ</span><span class="s4">,  </span><span class="s3">&quot;Hola&quot;</span><span class="s1">))</span><span class="s4">;</span>
    <span class="s1">open_udp_socket()</span><span class="s4">;</span>
    <span class="s1">send_udp_package(create_package(REGISTER_REQ</span><span class="s4">, </span><span class="s3">&quot;Hola&quot;</span><span class="s1">))</span><span class="s4">;</span>
    <span class="s1">print_debug(</span><span class="s3">&quot;Hemos enviado el paquete&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">receive_udp_package(</span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">print_package(package)</span><span class="s4">;</span>
<span class="s1">}</span>


</pre>
</body>
</html>